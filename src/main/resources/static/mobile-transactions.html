<!DOCTYPE html>
<html manifest="offline.manifest">
<head>
	<meta name="apple-mobile-web-app-capable" content="yes" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0"/>
	
    <meta charset="UTF-8">
    <meta name="viewport" content="initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Trasnaction List</title>
    <link rel="stylesheet" type="text/css" href="easyui/themes/metro/easyui.css">
    <link rel="stylesheet" type="text/css" href="easyui/themes/icon.css">
	<script type="text/javascript" src="easyui/jquery.min.js"></script>
	<script type="text/javascript" src="easyui/jquery.easyui.min.js"></script>
	<script type="text/javascript" src="js/data.js"></script>
    <script type="text/javascript" src="js/rest.js"></script>
	<script type="text/javascript" src="js/login.js"></script>
    
    <style scoped>
        .panel-title{
            text-align:center;
            font-size:14px;
            font-weight:bold;
            text-shadow:0 -1px rgba(0,0,0,0.3);
        }
        .datagrid-row,.datagrid-header-row{
            height:35px;
        }
        .datagrid-body td{  
            border-right:1px dotted transparent;  
            border-bottom:1px dotted transparent;  
        }  
    </style>

	<!-- icon for iphone -->
	<link rel="apple-touch-icon" sizes="57x57" href="images/icon-57.png" />
	<link rel="apple-touch-icon" sizes="80x80" href="images/icon-80.png" />
	<link rel="apple-touch-icon" sizes="120x120" href="images/icon-120.png" />

    <script type="text/javascript">
        
        $(function(){ //on page load event
        	var loggedIn = readIsLoggedIn();
    		if(loggedIn == null) {
					window.location = "mobile-login.html";
        	}
        	loadGridData();
        });
        
        function loadGridData() {
			var  gridDataObject = readTransactions();
            $('#dg').datagrid({
                data: gridDataObject
            });
        } 

		var selectedIndex;        
	    function onClickRow(index){
	    	selectedIndex = index;
	    }

	    function removeit(){
	        if (selectedIndex == undefined){
	        	return;
	        }
	        if (confirm('Are you sure you want to remove transaction?')) {
	    		$('#dg').datagrid('deleteRow', selectedIndex);
				removeTransaction(selectedIndex);
			}        
		}

	    function addNewTransaction() {
	    	window.location = "mobile-add-new.html";
	    }
	
		function postExpensesToServer() {
			var online = navigator.onLine;
			if(online) { //just connected to a network, I assume most probably you have Internet
				var transactions = readTransactions();
				if(transactions  == null || transactions.length == 0) {
					alert("There is no transactions to post.");
				}
				var resp = loginRest(readEmail(), readPassword());
				if(resp.status != "success") {
					alert("ERROR login");
					return false;
				}
				var trans;
				for( i = transactions.length-1 ; i >= 0; i--) { //loop from bottom to up for the grid deletion
					var status = postSingleTransaction(transactions[i]);
					if(status == true) {
						removeTransaction(i);
			    		$('#dg').datagrid('deleteRow', i);
					}

					//here I want to show balances
				}
			} else {
				alert("There is no internet connectivity try again when connected.");
			}
		}

		function seeAccountsBalance() {
			if(navigator.onLine) {
				window.location = "mobile-accounts.html";

			} else {
				alert("There is no internet connectivity try again when connected.");
			}
		}

		function postSingleTransaction(trans) {
			var success = true;
		   jQuery.ajax({
		       url : 'rest/transactions/saveTransaction.do',
		       async : false,
		       type : 'POST',  
		       dataType : 'json',
		       data : {
			       description: trans.description,
			       date: trans.date,
			       amount: trans.amount,
			       withdraw: trans.withdrawId,
			       deposit: trans.depositId,
			      },
		       success : function(response) {
		           if(response.success != true) {
		           		success = false;
		           		alert("Error posting to the server");
		           } 
		       }
		   });
		    
		    return success;
		}
	
	function logout() {
		storeLogout();
    	window.location = "mobile-login.html";
	}
        
    </script>

</head>
<body class="easyui-layout">

	<!-- Toolbar and Title  -->	
    <div data-options="region:'north',border:false" style="overflow:hidden">
        <div class="panel-header" style="padding:0 0 0 5px;border-width:1px 0;">
            <div style="float:right;padding:2px 5px">
                <a href="javascript:void(0)" class="easyui-linkbutton" data-options="iconCls:'icon-remove',plain:true" onclick="removeit()"></a>
                <a href="javascript:void(0)" class="easyui-linkbutton" data-options="iconCls:'icon-add',plain:true" onclick="addNewTransaction()"></a>
                <a href="javascript:void(0)" class="easyui-linkbutton" data-options="plain:true" onclick="postExpensesToServer()">Post</a>
				<a href="javascript:void(0)" class="easyui-linkbutton" data-options="plain:true" onclick="seeAccountsBalance()">Accounts</a>
                <a href="javascript:void(0)" class="easyui-linkbutton" data-options="plain:true" onclick="logout()">Logout</a>
            </div>
            <span class="panel-title" style="line-height:30px">Transactions</span>
            <div style="clear:both"></div>
        </div>
    </div>
    
	<!-- Transactions Data Grid  -->    
	<div data-options="region:'center',border:false">
    	<table id="dg" data-options="
                iconCls: 'icon-edit',
                singleSelect: true,
                fit:true,
                fitColumns:true,
                border: false,
                scrollbarSize: 0,
                onClickRow: onClickRow
            ">
	        <thead>
	            <tr>
	                <th data-options="field:'description',width:80">Description</th>
	                <th data-options="field:'withdrawVal',width:100,editor:'text'">Withdraw From</th>
	                <th data-options="field:'depositVal',width:80,align:'right',editor:{type:'numberbox',options:{precision:1}}">Deposit Into</th>
	                <th data-options="field:'date',width:80,align:'right',editor:'numberbox'">Date</th>
	                <th data-options="field:'amount',width:80,align:'right',editor:'numberbox'">Amount</th>
	            </tr>
	        </thead>
	    </table>
    </div>

</body>
</html>